- breadcrumb :test_run, current_project, @test_run

- content_for :page_title do
  = link_to project_branch_test_runs_path(current_project,
    @test_run.tracked_branch) do
    = "Test Run ##{@test_run.id}"

.panel.panel-default{ data: { test_run_id: @test_run.id }}
  .panel-heading.test-run-panel-heading
    .pull-left
      %h3
        #{@test_run.commit_message(render_as_link: true)}
        %br
        #{@test_run.commit_info}
    .test
      .pull-right
        = render partial: 'test_run_actions', locals: { test_run: @test_run }
  .col-md-12
    .progress{ data: @test_run.class.test_job_statuses[@test_run.id], id: @test_run.id }
  .panel-body
    .row
      .col-xs-12
        .table-responsive
          %table.table
            %thead
              %tr
                %th='Job name'
                %th='Status'
                %th='Sent at (UTC)'
                - if current_user.admin?
                  %th='Chunk index'
                  %th='Cost prediction'
                  %th='Worker command seconds'
                %th='Duration'
                %th='Actions'
            %tbody
              - @test_jobs.each do |test_job|
                - test_job = test_job.decorate
                %tr{id: "test-job-#{test_job.id}"}
                  %td= test_job.job_name
                  %td
                    %span{class: test_job.status.css_class}= test_job.status.text
                  %td= l(test_job.sent_at, format: :short) if test_job.sent_at
                  - if current_user.admin?
                    %td= test_job.chunk_index
                    %td
                      = test_job.avg_worker_command_run_seconds
                    %td
                      = test_job.worker_command_run_seconds
                  %td
                    = test_job.total_running_time
                  %td
                    - if test_job.status.terminal?
                      = link_to project_test_job_retry_path(current_project,
                        test_job),
                        class: "btn btn-primary btn-xs m-b-5", method: :put do
                        %i.fa.fa-refresh
                        %span= "Retry"
                      - if test_job.rerun?
                        .btn.btn-xs{ data: { toggle: "tooltip",
                          title: "This job has been retried. The times shown are those of the first execution" } }
                          %i.fa.fa-info

                - if test_job.status.unsuccessful?
                  %tr.danger
                    %td{ colspan: 10, style: "text-align: left" }= simple_format(test_job.result)
