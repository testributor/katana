- breadcrumb :test_run, current_project, @run

- content_for :page_title do
  = link_to project_branch_test_runs_path do
    = "Test Run ##{@run.id}"
.panel.panel-default
  .panel-heading.test-run-panel-heading
    .pull-left
      %h3
        #{@run.decorate.commit_message(render_as_link: true)}
        %br
        #{@run.decorate.commit_info}
    .test
      .pull-right
        = render partial: 'test_run_actions', locals: { test_run: @run }
  .panel-body
    .row
      .col-xs-12
        .table-responsive
          %table.table
            %thead
              %tr
                %th='File'
                %th='Status'
                %th='Errors'
                %th='Failures'
                %th='Tests'
                %th='Assertions'
                %th='Skips'
                %th='Completed at (UTC)'
                %th='Total running time'
                %th='Actions'
            %tbody
              - @test_jobs.each do |test_job|
                %tr
                  %td= test_job.command
                  %td
                    %span{class: test_job.status.css_class}= test_job.status.text
                  %td= test_job.test_errors
                  %td= test_job.failures
                  %td= test_job.count
                  %td= test_job.assertions
                  %td= test_job.skips
                  %td= l(test_job.completed_at, format: :short) if test_job.completed_at
                  %td
                    - if test_job.total_running_time
                      = distance_of_time_in_words(0, test_job.total_running_time, include_seconds: true)
                  %td
                    - if test_job.status.terminal?
                      - # TODO: tracked branch and test_run nesting seems unecessary
                      - # for the test_job resource. We only need the project for
                      - # validation/authorization purposes (to let it work in the
                      - # same way the rest of the routes work).
                      = link_to project_branch_test_run_test_job_path(current_project,
                        test_job.test_run.tracked_branch.id, test_job.test_run.id, test_job,
                        status: test_job.status.status_to_set),
                        class: "#btn btn-primary btn-xs m-b-5", method: :put do
                        %i.fa.fa-refresh
                        %span= test_job.status.cta_text

                - if test_job.status.failed? || test_job.status.error?
                  %tr.danger
                    %td{ colspan: 10, style: "text-align: left" }=simple_format(test_job.result)
